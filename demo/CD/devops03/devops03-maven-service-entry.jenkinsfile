@Library("mylib@main") _
import org.devops.*

// ========== å·¥å…·ç±»åˆå§‹åŒ– ==========
def artifacts = new Artifacts()
def notified = new Notified()

// ========== ä¸‹æ¸¸ä»»åŠ¡ ==========
def jobs = [
    'TST/devops03/devops03-maven-service-dockercompose',
    'TST/devops03/devops03-maven-service',
    'TST/devops03/devops03-maven-service-standard'
]

def all_jobs = jobs.join(',')

pipeline {
    agent any

     options {
        skipDefaultCheckout true
        timestamps()
    }


    parameters {
        // Extended Choice Parameter - å¤šé€‰å‚æ•°
        extendedChoice(
            name: 'DOWNSTREAM_JOBS',
            type: 'PT_CHECKBOX',
            value: all_jobs,
            defaultValue: all_jobs,  // è¿™é‡Œè®¾ç½®é»˜è®¤å…¨é€‰
            description: 'é€‰æ‹©è¦è§¦å‘çš„ä¸‹æ¸¸ä»»åŠ¡',
            multiSelectDelimiter: ',',
            visibleItemCount: 5
        )

        string 'releaseVersion'
    }
    
    stages {
        stage('è§¦å‘ä¸‹æ¸¸') {
            steps {
                script {
                    echo "ğŸš€ å¼€å§‹è§¦å‘ä¸‹æ¸¸ä»»åŠ¡"
                    
                    // å¤„ç†é€‰ä¸­çš„ä»»åŠ¡
                    def selectedJobs = params.DOWNSTREAM_JOBS.split(',').collect { it.trim() }
                    
                    echo "å·²é€‰æ‹© ${selectedJobs.size()} ä¸ªä»»åŠ¡ï¼š"
                    selectedJobs.each { job ->
                        echo "  â€¢ ${job}"
                    }
                    
                    // å¹¶è¡Œè§¦å‘
                    parallel selectedJobs.collectEntries { jobName ->
                        ["è§¦å‘ ${jobName}": {
                            echo "è§¦å‘: ${jobName}"
                            build job: jobName, wait: false, parameters: [
                                string(name: 'releaseVersion', value: params.releaseVersion)
                            ]
                        }]
                    }
                    
                    echo "âœ… æ‰€æœ‰ä»»åŠ¡å·²è§¦å‘"
                }
            }
        }
    }

    post {
        always{
            wrap([$class: 'BuildUser']) {
                script {
                    def causes = currentBuild.getBuildCauses()
                    env.triggerDescription = causes ? causes[0].shortDescription : "æœªçŸ¥è§¦å‘"

                    // è®¾ç½®æ„å»ºæè¿°
                    currentBuild.description = """                           
                        Jobs: ${env.DOWNSTREAM_JOBS}                 
                        Version: ${env.releaseVersion}
                    """.stripIndent().trim()
                    currentBuild.displayName = "#${env.BUILD_NUMBER} - ${env.triggerDescription}"
                
                    // å‘é€æ„å»ºé€šçŸ¥
                    env.USER_EMAIL = "${env.webhook_userEmail ?: env.BUILD_USER_EMAIL ?: params.PARAMS_USER_EMAIL}"
                    notified.SendEmail("${env.USER_EMAIL}")

                }
            }
        }        
    }
}